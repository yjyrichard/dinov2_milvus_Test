# 外观专利检索接口文档

> 基础路径: `/api/design`

---

## 1. 图像搜索

以图搜图，支持关键词过滤。

### 请求

```
POST /api/design/search
Content-Type: multipart/form-data
```

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| file | File | ✅ | - | 上传的图片文件 |
| top_k | int | ❌ | 10 | 返回结果数量 |
| min_score | float | ❌ | 0.4 | 最低相似度阈值 (0-1) |
| keyword | string | ❌ | - | 关键词，搜索标题 |
| loc_class | string | ❌ | - | LOC 分类号，如 "0204" |
| applicant | string | ❌ | - | 申请人名称 |

### 响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "results": [
      {
        "patent_id": "USD1012345",
        "max_score": 0.85,
        "title": "Shoe",
        "loc_class": "0204",
        "pub_date": 20240115,
        "filing_date": 20230601,
        "applicant_name": "Nike Inc.",
        "applicant_country": "US",
        "inventor_names": "John Doe",
        "claim_text": "The ornamental design for a shoe...",
        "image_count": 7,
        "pages": [
          {
            "id": 12345,
            "image_index": 1,
            "file_name": "USD10123450001.TIF",
            "file_path": "http://minio:9000/bucket/design_patents/USD1012345/USD10123450001.TIF",
            "score": 0.85
          }
        ]
      }
    ],
    "timing": {
      "feature_extraction_ms": 80.5,
      "milvus_search_ms": 12.3,
      "post_process_ms": 1.2,
      "total_ms": 95.0
    },
    "query_info": {
      "top_k": 10,
      "min_score": 0.4,
      "keyword": null,
      "loc_class": null,
      "applicant": null,
      "total_matched": 25
    }
  }
}
```

### 错误响应

```json
{
  "code": 1,
  "message": "错误信息",
  "data": null
}
```

---

## 2. 获取专利详情

获取指定专利的所有图片和元数据。

### 请求

```
GET /api/design/patent/{patent_id}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| patent_id | string | ✅ | 专利号，如 "USD1012345" |

### 响应

```json
{
  "code": 0,
  "data": {
    "patent_id": "USD1012345",
    "images": [
      {
        "id": 12345,
        "image_index": 1,
        "file_name": "USD10123450001.TIF",
        "file_path": "http://minio:9000/bucket/design_patents/USD1012345/USD10123450001.TIF",
        "title": "Shoe",
        "loc_class": "0204",
        "pub_date": 20240115,
        "filing_date": 20230601,
        "applicant_name": "Nike Inc.",
        "applicant_country": "US",
        "inventor_names": "John Doe",
        "claim_text": "The ornamental design for a shoe...",
        "image_count": 7
      }
    ],
    "metadata": {
      "title": "Shoe",
      "loc_class": "0204",
      "pub_date": 20240115,
      "filing_date": 20230601,
      "applicant_name": "Nike Inc.",
      "applicant_country": "US",
      "inventor_names": "John Doe",
      "claim_text": "The ornamental design for a shoe...",
      "image_count": 7
    }
  }
}
```

---

## 3. 获取统计信息

获取 Collection 和模型状态。

### 请求

```
GET /api/design/stats
```

### 响应

```json
{
  "code": 0,
  "data": {
    "collection": {
      "name": "design_patents",
      "num_entities": 150000,
      "index_status": "ready"
    },
    "model": {
      "name": "dinov2-base",
      "device": "cuda",
      "dimension": 768
    }
  }
}
```

---

## 4. 获取图片

获取专利图片（自动转换 TIF 为 JPEG）。

### 请求

```
GET /api/design/image/{patent_id}/{file_name}?thumbnail=true
```

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| patent_id | string | path | ✅ | 专利号 |
| file_name | string | path | ✅ | 文件名，如 "USD10123450001.TIF" |
| thumbnail | bool | query | ❌ | 是否返回缩略图 (默认 false) |

### 响应

- Content-Type: `image/jpeg`
- 返回图片二进制流

### 错误响应

- 404: 图片不存在
- 500: 图片处理失败

---

## 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| patent_id | string | 专利号，如 "USD1012345" |
| title | string | 专利标题 |
| loc_class | string | LOC 国际外观设计分类号 |
| pub_date | int | 公开日期，格式 YYYYMMDD |
| filing_date | int | 申请日期，格式 YYYYMMDD |
| applicant_name | string | 申请人名称 |
| applicant_country | string | 申请人国家代码 |
| inventor_names | string | 发明人姓名 |
| claim_text | string | 权利要求文本 |
| image_count | int | 该专利的图片总数 |
| image_index | int | 图片序号 (从 1 开始) |
| score | float | 相似度分数 (0-1) |
| max_score | float | 该专利下所有图片的最高相似度 |

---

## 前端调用示例

```javascript
// 搜索
const formData = new FormData()
formData.append('file', imageFile)
formData.append('top_k', 10)
formData.append('min_score', 0.4)
formData.append('keyword', 'Shoe')

const res = await fetch('/api/design/search', {
  method: 'POST',
  body: formData
})
const data = await res.json()

// 获取图片 URL
const thumbnailUrl = `/api/design/image/${patentId}/${fileName}?thumbnail=true`
const originalUrl = `/api/design/image/${patentId}/${fileName}`
```

---

*文档更新时间: 2026-01-16*
