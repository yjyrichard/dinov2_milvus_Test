# 跨境电商侵权检测系统 - 需求分析

## 一、项目概述

构建一个跨境电商侵权检测系统，帮助卖家检测商品是否存在专利侵权风险。

### 1.1 核心思路

**两套数据，两种检索方式：**

>  **重要**：外观专利和发明专利是**完全不同的数据源**，需要分别处理。详见 `外观专利和发明专利.md`(查一下也行bing上搜)

```
USPTO专利数据
    │
    ├── 外观专利 (Design Patent) ─ 专利号以 D 开头，如 USD987654
    │   ├── 数据特点：图片为主，文字极少（通常只有一句话）
    │   ├── 分类体系：LOC（洛迦诺分类）
    │   └── 图片 (TIF) ──→ DINOv2向量化 ──→ 外观检索（以图搜图）
    │
    └── 发明专利 (Utility Patent) ─ 纯数字专利号，如 US20250359498A1
        ├── 数据特点：文字丰富（摘要、权利要求、说明书几十页）
        ├── 分类体系：IPC/CPC
        └── 文本 (摘要/权利要求) ──→ BERT向量化 ──→ 发明检索（以文搜文）
```

### 1.2 两种检索的本质

| | 外观专利检索 | 发明专利检索 |
|--|------------|------------|
| **数据来源** | Design Patent（D开头） | Utility Patent（纯数字） |
| **分类体系** | LOC（洛迦诺分类） | IPC/CPC |
| **用户输入** | 商品图片 | 产品标题+描述 |
| **对比目标** | 专利附图 (TIF) | 专利摘要/权利要求 |
| **向量化模型** | DINOv2 | BERT |
| **检索逻辑** | 图片向量相似度 | 文本向量相似度 |

本质上都是：**用户输入 → 向量化 → 在向量库中找相似的 → 返回结果**

## 二、核心功能模块

### 2.1 外观专利检测

**输入：**

- 商品图片
- 商品名 [kexuan]
- 上架国家/平台

**处理流程：**

| 步骤 | 描述 |
|------|------|
| 步骤一 | 1.识别外观专利图片；2.检测实物图与专利线条图，对比相似度从高到低排序（默认综合对比）；3.商品名辅助定位品类减少搜索范围（非必填） |
| 步骤二（可选） | 高级筛选：检测方式选择（实物+专利综合对比/仅实物对比）、关键词、专利状态（有效/无效）、LOC分类（工业品外观设计分类目录，可根据图片自动归类）、受理局国家  【刚开始这个先搁置一下做个MVP先】 |
| 步骤三 | 按风险（相似度）从高到低排序专利，可自定义增加对比专利 |

**输出：**
- 综合侵权等级（高/中/低）
- 分级专利明细：
  - 外观大图
  - 公开号
  - 五书 + 图片 + 摘要翻译
  - 所属公司/申请人（可查看该公司历史专利记录）
  - 预估专利到期时间
- 高风险侵权部件分析

### 2.2 发明专利检测

**输入：**
- 产品标题
- 产品描述
- 上架国家/平台

**处理流程：**

| 步骤 | 描述 |
|------|------|
| 步骤一 | 语义理解产品的 **IPC/CPC 分类**、产品属性、功能描述中的实施例应用方式进行匹配 |
| 步骤二（可选） | 高级筛选：关键词、专利关键词、专利状态（有效/无效）、受理局国家 |
| 步骤三 | 按风险（相似度）从高到低排序专利，可自定义增加对比专利 |

**输出：**
- 综合侵权等级（高/中/低）
- 分级专利明细（同外观专利）
- 高风险实施例分析：给出所涉及的功能部件造成风险的原因

## 三、数据源

### 3.1 发明专利 (Utility Patent)

- **来源**：USPTO Utility Patent 数据
- **专利号格式**：纯数字，如 `US20250359498A1`
- **当前数据**：已有 `数据/I20251127` 目录
- **需要索引的数据字段**：
  - 专利文本（标题、摘要、权利要求、说明书）— 文本向量检索核心
  - 专利附图（TIF）— 辅助展示用，非检索核心
  - 公开号
  - 申请人/所属公司
  - 专利状态（有效/无效）
  - **IPC/CPC 分类**（国际专利分类）
  - 受理局国家
  - 申请日期/授权日期/到期时间

### 3.2 外观专利 (Design Patent)

- **来源**：USPTO Design Patent 数据
- **专利号格式**：以 D 开头，如 `USD1107373`
- **当前数据**：已有 `数据/I20251230_r1/I20251230/DESIGN/` 目录
- **需要索引的数据字段**：
  - 专利图片（TIF线条图）— **图片向量检索核心**
  - 公开号
  - 申请人/所属公司
  - 专利状态（有效/无效）
  - **LOC 分类**（洛迦诺分类，工业品外观设计分类）
  - 受理局国家
  - 申请日期/授权日期/到期时间
  - 摘要 — 通常只有一句话，如 "The ornamental design for a cup, as shown."

## 四、索引需求分析

### 4.1 检索类型

| 检索类型 | 应用场景 | 特点 |
|---------|---------|------|
| **图像相似度检索** | 外观专利检测 - 实物图与专利线条图对比 | 需要图像特征提取 + 向量相似度计算 |
| **语义文本检索** | 发明专利检测 - 产品描述与专利文本语义匹配 | 需要文本向量化 + 语义相似度计算 |
| **结构化筛选** | 二次筛选 - 专利状态、分类号、国家等 | 外观用LOC，发明用IPC/CPC |
| **关键词检索** | 专利关键词匹配 | 全文检索 |

### 4.2 核心挑战

1. **图像检索**：需要将专利线条图和实物图转换为向量，计算相似度
2. **语义检索**：需要理解产品描述的语义，与专利文本进行匹配
3. **混合检索**：同时支持向量检索 + 结构化过滤

## 五、技术选型

### 5.1 确定方案

| 组件 | 选型 | 说明 |
|------|------|------|
| **向量数据库** | Milvus | 待确认 |
| **图像向量化** | DINOv2 | 专利线条图推荐，关注几何结构 |
| **文本向量化** | BERT | 待确认 |

### 5.2 向量维度说明

**维度是模型架构决定的，不是我们选择的。**

| 模型 | 版本 | 输出维度 | 速度 | 效果 |
|------|------|---------|------|------|
| DINOv2 | ViT-B/14 | **768** | 中 | 专利线条图推荐 |
| CLIP | ViT-B/32 | 512 | 快 | 实物图常用 |
| BERT | base | **768** | 快 | 常用 |
| BERT | large | 1024 | 慢 | 更准 |

**示例**：用 DINOv2 ViT-B/14 处理一张图片，输出就是一个长度为 768 的浮点数数组。

```python
# DINOv2 示例
import torch
from transformers import AutoImageProcessor, AutoModel

processor = AutoImageProcessor.from_pretrained('facebook/dinov2-base')
model = AutoModel.from_pretrained('facebook/dinov2-base')

image = Image.open("patent.tif")
inputs = processor(images=image, return_tensors="pt")
outputs = model(**inputs)
image_features = outputs.last_hidden_state[:, 0, :]  # 取CLS token
# image_features.shape = [1, 768]  ← 768维向量
```

```python
# BERT 示例
from transformers import BertModel, BertTokenizer
model = BertModel.from_pretrained("bert-base-uncased")
tokenizer = BertTokenizer.from_pretrained("bert-base-uncased")

text = "A method for hip joint replacement..."
inputs = tokenizer(text, return_tensors="pt", truncation=True, max_length=512)
outputs = model(**inputs)
text_features = outputs.last_hidden_state[:, 0, :]  # 取[CLS]向量
# text_features.shape = [1, 768]  ← 768维向量
```

**注意**：实际使用的版本需要和mentor确认，本文档假设使用base版本。

### 5.3 为什么选 Milvus

1. 专为向量检索设计，大规模数据性能优秀
2. 支持多种索引类型（IVF_FLAT, HNSW, IVF_PQ 等）
3. 支持标量字段过滤（专利状态、分类号等）
4. 社区成熟，文档完善 【图搜图官网有一个示例：[使用 Milvus 搜索图像 | Milvus 文档](https://milvus.io/docs/zh/image_similarity_search.md#Image-Search-with-Milvus)】

### 5.3 大数据量注意事项

由于数据量较大，需要注意：

| 问题 | 解决方案 |
|------|---------|
| **索引类型选择** | 小数据量用 FLAT（精确），大数据量用 IVF_FLAT 或 HNSW（近似但快） |
| **内存占用** | IVF_PQ 可压缩向量，降低内存占用 |
| **导入效率** | 分批导入，每批 10000-50000 条 |
| **Collection设计** | 按专利类型分开：外观专利用图片向量，发明专利用文本向量 |

### 5.4 Milvus Collection 设计

#### 发明专利 Collection

**Collection: utility_patent_texts（发明专利-文本向量）**

```python
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
    FieldSchema(name="patent_id", dtype=DataType.VARCHAR, max_length=50),  # 如 US20250359498A1
    FieldSchema(name="title", dtype=DataType.VARCHAR, max_length=500),
    FieldSchema(name="abstract", dtype=DataType.VARCHAR, max_length=5000),
    FieldSchema(name="text_vector", dtype=DataType.FLOAT_VECTOR, dim=768),  # BERT输出维度
    # 结构化字段用于过滤
    FieldSchema(name="ipc_class", dtype=DataType.VARCHAR, max_length=100),  # IPC分类
    FieldSchema(name="cpc_class", dtype=DataType.VARCHAR, max_length=100),  # CPC分类
    FieldSchema(name="pub_date", dtype=DataType.INT64),  # YYYYMMDD格式
    FieldSchema(name="status", dtype=DataType.VARCHAR, max_length=20),  # 有效/无效
]
index_params = {"metric_type": "IP", "index_type": "IVF_FLAT", "params": {"nlist": 1024}}
```

#### 外观专利 Collection

**Collection: design_patent_images（外观专利-图片向量）**

```python
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
    FieldSchema(name="patent_id", dtype=DataType.VARCHAR, max_length=50),  # 如 USD987654
    FieldSchema(name="image_file", dtype=DataType.VARCHAR, max_length=200),
    FieldSchema(name="image_vector", dtype=DataType.FLOAT_VECTOR, dim=512),  # CLIP/DINOv2输出维度
    # 结构化字段用于过滤
    FieldSchema(name="loc_class", dtype=DataType.VARCHAR, max_length=100),  # LOC分类
    FieldSchema(name="pub_date", dtype=DataType.INT64),  # YYYYMMDD格式
    FieldSchema(name="status", dtype=DataType.VARCHAR, max_length=20),  # 有效/无效
]
index_params = {"metric_type": "IP", "index_type": "IVF_FLAT", "params": {"nlist": 1024}}
```

> 注：外观专利的摘要通常只有一句话，不需要做文本向量索引

## 六、索引设计草案

### 6.1 发明专利数据结构

```
UtilityPatent {
    patent_id: string           // 公开号，如 US20250359498A1
    title: string               // 专利标题
    abstract: string            // 摘要（语义检索核心）
    claims: string              // 权利要求（法律保护范围）
    description: string         // 说明书

    text_vector: float[]        // 文本语义向量 (BERT 768维)

    applicant: string           // 申请人
    company: string             // 所属公司
    status: string              // 专利状态 (有效/无效)
    ipc_class: string[]         // IPC分类（国际专利分类）
    cpc_class: string[]         // CPC分类（联合专利分类）
    country: string             // 受理局国家
    filing_date: date           // 申请日期
    grant_date: date            // 授权日期
    expiry_date: date           // 到期日期

    images: string[]            // 专利附图URL列表（辅助展示）
}
```

### 6.2 外观专利数据结构

```
DesignPatent {
    patent_id: string           // 公开号，以D开头，如 USD987654
    title: string               // 专利标题（通常很简短）
    abstract: string            // 摘要（通常只有一句话，如 "The ornamental design for a cup, as shown."）

    image_vectors: float[][]    // 专利图片向量数组 (DINOv2 768维)

    applicant: string           // 申请人
    company: string             // 所属公司
    status: string              // 专利状态 (有效/无效)
    loc_class: string[]         // LOC分类（洛迦诺分类）
    country: string             // 受理局国家
    filing_date: date           // 申请日期
    grant_date: date            // 授权日期
    expiry_date: date           // 到期日期（外观专利通常15年）

    images: string[]            // 专利图片URL列表（检索核心）
}
```

### 6.3 向量化方案

| 专利类型 | 数据类型 | 模型 | 输出维度 | 说明 |
|---------|---------|------|---------|------|
| 外观专利 | 专利图片 (TIF) | **DINOv2** | 768 | 图片向量检索核心，关注几何结构 |
| 发明专利 | 专利文本 | **BERT** | 768 | 文本向量检索核心 |

CLIP：是几十亿对“图片-文字”训练出来的，它学习的是“语义概念”。它看到照片里的杯子，理解的是“cup”；看到线条画的杯子也能理解那是“cpu” 有一定的跨域匹配能力

DIN0Ov2 ： 这个模型我查了一下目前这个模型是对结构理解最强的，传统模型非常依赖纹理。但是这个模型它使用一种子监督，非常擅长捕捉物体的几何结构和布局，忽略颜色还有纹理。我觉得这个会好点是完美符合我们的需求的，专利图就是只有结构没有纹理。Hugging Face 上面有现成的预训练模型  [DINOv2 --- DINOv2](https://huggingface.co/docs/transformers/v4.49.0/en/model_doc/dinov2)

## 七、职责范围

- 根据 USPTO 专利数据建立索引
- 设计索引结构
- 实现向量化处理
- 提供检索接口（供前后端调用）

**不涉及：**

- 前端界面开发
- 后端业务逻辑

## 八、USPTO XML 数据结构详解

> **注意**：本章节包含**发明专利 (Utility Patent)** 和 **外观专利 (Design Patent)** 两种 XML 结构的详解。

### 8.1 发明专利文件结构

每个专利ZIP包含：
- `.XML` 文件 - 专利完整数据
- `.TIF` 文件 - 专利附图（多张）

### 8.2 发明专利 XML 主要结构

```
us-patent-application
├── us-bibliographic-data-application  # 书目数据（元数据）
│   ├── publication-reference          # 公开信息
│   │   ├── doc-number                  # 公开号 (如 20250360003)
│   │   ├── kind                        # 文献类型 (A1=申请公开, B1/B2=授权)
│   │   └── date                        # 公开日期 (YYYYMMDD)
│   ├── application-reference           # 申请信息
│   │   └── doc-number                  # 申请号
│   ├── classifications-ipcr            # IPC国际专利分类
│   ├── classifications-cpc             # CPC联合专利分类（更细） 《====如果需要 当前默认jia
│   ├── invention-title                 # 发明名称
│   └── us-parties                      # 当事人信息
│       ├── us-applicants               # 申请人
│       └── inventors                   # 发明人
├── abstract                            # 摘要 《=======语义检索核心
├── drawings                            # 附图列表
│   └── figure -> img[@file]            # TIF图片文件名
├── description                         # 说明书（详细技术描述）
└── claims                              # 权利要求书 《========法律保护范围
```

注意：上面是比较通用的结果 但是有一些不太一样。比如说 further-cpc,assignees 等可能缺失，部分字段如（CPC ,Inventor）包含多个值 

### 8.3 发明专利关键字段提取映射（完整XML路径）

| 索引字段 | 完整XML路径 | 示例值 | 索引方式 |
|---------|-------------|--------|---------|
| **patent_id** | `/us-patent-application/us-bibliographic-data-application/publication-reference/document-id/doc-number` + `/kind` | `US20250360003A1` | 主键 |
| **title** | `/us-patent-application/us-bibliographic-data-application/invention-title` | `Hip Joint Method` | 全文+向量 |
| **abstract** | `/us-patent-application/abstract/p` | 摘要文本 | **文本向量** |
| **claims** | `/us-patent-application/claims/claim/claim-text` | 权利要求文本（多条拼接） | 文本向量 |
| **description** | `/us-patent-application/description/p` | 说明书文本 | 可选向量 |
| **ipc_class** | `/us-patent-application/us-bibliographic-data-application/classifications-ipcr/classification-ipcr` 下的 `section`+`class`+`subclass`+`main-group`+`/`+`subgroup` | `A61F2/46` | 结构化过滤 |
| **cpc_class** | `/us-patent-application/us-bibliographic-data-application/classifications-cpc/main-cpc/classification-cpc` 和 `further-cpc/classification-cpc` | `A61F2/4607` | 结构化过滤 |
| **applicant_name** | `/us-patent-application/us-bibliographic-data-application/us-parties/us-applicants/us-applicant/addressbook/first-name` + `last-name` | `Peter Forsell` | 全文索引 |
| **applicant_country** | 同上路径下 `/address/country` | `SE` | 过滤 |
| **inventor_name** | `/us-patent-application/us-bibliographic-data-application/us-parties/inventors/inventor/addressbook/first-name` + `last-name` | `Peter Forsell` | 全文索引 |
| **filing_date** | `/us-patent-application/us-bibliographic-data-application/application-reference/document-id/date` | `20240521` | 范围过滤 |
| **pub_date** | `/us-patent-application/us-bibliographic-data-application/publication-reference/document-id/date` | `20251127` | 范围过滤 |
| **country** | `/us-patent-application/us-bibliographic-data-application/publication-reference/document-id/country` | `US` | 精确过滤 |
| **images** | `/us-patent-application/drawings/figure/img/@file` | `US20250360003A1-20251127-D00001.TIF` | 存储 |
| **image_vectors** | 图片经DINOv2向量化 | float[768] | **图片向量检索** |
| **text_vector** | 摘要+标题经BERT向量化 | float[768] （base版本） | **文本向量检索** |

### 8.4 字段解析代码示例

```python
import xml.etree.ElementTree as ET

def parse_patent_xml(xml_path):
    """解析USPTO专利XML文件"""
    tree = ET.parse(xml_path)
    root = tree.getroot()

    # 书目数据根节点
    biblio = root.find('us-bibliographic-data-application')
    pub_ref = biblio.find('publication-reference/document-id')
    app_ref = biblio.find('application-reference/document-id')

    patent = {
        # 公开号 = country + doc-number + kind
        'patent_id': f"{pub_ref.find('country').text}{pub_ref.find('doc-number').text}{pub_ref.find('kind').text}",
        'pub_date': pub_ref.find('date').text,
        'filing_date': app_ref.find('date').text,
        'title': biblio.find('invention-title').text,

        # 摘要
        'abstract': ' '.join([p.text or '' for p in root.findall('.//abstract/p')]),

        # 权利要求（多条拼接）
        'claims': ' '.join([ct.text or '' for ct in root.findall('.//claims/claim/claim-text')]),

        # IPC分类（多个）
        'ipc_classes': [parse_ipc(ipc) for ipc in biblio.findall('.//classification-ipcr')],

        # 图片文件名列表
        'images': [img.get('file') for img in root.findall('.//drawings/figure/img')],

        # 申请人
        'applicants': [parse_applicant(app) for app in biblio.findall('.//us-applicant')],
    }
    return patent

def parse_ipc(ipc_node):
    """解析IPC分类号: A61F2/46"""
    s = ipc_node.find('section').text or ''
    c = ipc_node.find('class').text or ''
    sc = ipc_node.find('subclass').text or ''
    mg = ipc_node.find('main-group').text or ''
    sg = ipc_node.find('subgroup').text or ''
    return f"{s}{c}{sc}{mg}/{sg}"

def parse_applicant(app_node):
    """解析申请人信息"""
    addr = app_node.find('addressbook')
    first = addr.find('first-name')
    last = addr.find('last-name')
    return f"{first.text if first is not None else ''} {last.text if last is not None else ''}".strip()
```

### 8.5 IPC分类号含义

以 `A61F 2/46` 为例：
- `A` - 部（Section）：人类生活必需
- `61` - 大类（Class）：医学或兽医学
- `F` - 小类（Subclass）：可植入血管内的滤器
- `2/46` - 主组/分组：人工关节

### 8.5.1 发明专利XML完整标签解析及索引决策

> 基于5篇实际数据分析：US20250359498A1, US20250359500A1, US20250359505A1, US20250359520A1, US20250359550A1

#### 一、XML标签完整列表（中英对照）

```
us-patent-application                        # 美国专利申请（根元素）
│   属性：lang=语言, country=国家, date-produced=生成日期, date-publ=公开日期
│
├── us-bibliographic-data-application        # 申请专利书目数据
│   │
│   ├── publication-reference                # 公开信息
│   │   └── document-id                      # 文档标识
│   │       ├── country                      # 国家 (US)
│   │       ├── doc-number                   # 公开号 (纯数字，如 20250359498)
│   │       ├── kind                         # 文献类型 (A1=申请公开)
│   │       └── date                         # 公开日期 (YYYYMMDD)
│   │
│   ├── application-reference                # 申请信息
│   │   │   属性：appl-type="utility"        # 申请类型=发明专利
│   │   └── document-id
│   │       ├── country                      # 国家
│   │       ├── doc-number                   # 申请号
│   │       └── date                         # 申请日期
│   │
│   ├── us-application-series-code           # 申请系列号 (18/19)
│   │
│   ├── priority-claims                      # 优先权声明（可选）
│   │   └── priority-claim
│   │       ├── country                      # 优先权国家 (JP/DE/WO等)
│   │       ├── doc-number                   # 优先权文档号
│   │       └── date                         # 优先权日期
│   │
│   ├── classifications-ipcr                 # IPC国际专利分类 ★★★重要
│   │   └── classification-ipcr              # 分类条目（多个）
│   │       ├── ipc-version-indicator/date   # IPC版本
│   │       ├── section                      # 部 (A-H)
│   │       ├── class                        # 大类 (01-99)
│   │       ├── subclass                     # 小类 (A-Z)
│   │       ├── main-group                   # 主组
│   │       ├── subgroup                     # 分组
│   │       ├── symbol-position              # F=首要, L=后续
│   │       └── classification-value         # I=发明信息
│   │
│   ├── classifications-cpc                  # CPC联合专利分类 ★★★重要
│   │   ├── main-cpc                         # 主CPC分类
│   │   │   └── classification-cpc           # 分类详情（同IPC结构）
│   │   └── further-cpc                      # 附加CPC分类
│   │       └── classification-cpc           # 多个附加分类
│   │
│   ├── invention-title                      # 发明名称 ★★★重要
│   │                                        # 如 "Methods of Operating a Pulse Width Modulation Valve"
│   │
│   ├── us-related-documents                 # 相关文档（可选）
│   │   ├── continuation                     # 延续申请
│   │   │   └── relation
│   │   │       ├── parent-doc               # 母案（含 PCT 信息）
│   │   │       └── child-doc                # 子案
│   │   └── us-provisional-application       # 临时申请
│   │       └── document-id
│   │
│   ├── us-parties                           # 当事人信息 ★★重要
│   │   ├── us-applicants                    # 申请人
│   │   │   └── us-applicant
│   │   │       │ 属性：applicant-authority-category
│   │   │       │      (assignee/obligated-assignee)
│   │   │       ├── addressbook
│   │   │       │   ├── orgname              # 公司名称（如有）
│   │   │       │   ├── last-name            # 姓
│   │   │       │   ├── first-name           # 名
│   │   │       │   └── address
│   │   │       │       ├── city             # 城市
│   │   │       │       ├── state            # 州（可选）
│   │   │       │       └── country          # 国家
│   │   │       └── residence                # 居住地
│   │   │
│   │   └── inventors                        # 发明人（多个）★★重要
│   │       └── inventor
│   │           └── addressbook              # 同上
│   │
│   └── assignees                            # 受让人/专利权人（可选）
│       └── assignee
│           └── addressbook
│               ├── orgname                  # 公司名称
│               ├── role                     # 角色代码
│               └── address
│
├── abstract                                 # 摘要 ★★★核心（语义检索核心）
│   └── p                                    # 段落（通常1段，描述发明要点）
│
├── drawings                                 # 附图
│   └── figure                               # 附图条目（多个）
│       └── img                              # 图片
│           属性：id, he=高度, wi=宽度, file=文件名,
│                 orientation=方向, img-format="tif"
│
├── description                              # 说明书 ★★重要（内容最丰富）
│   ├── cross-reference-to-related-applications   # 相关申请交叉引用
│   ├── heading                              # 章节标题
│   ├── p                                    # 段落（大量）
│   ├── description-of-drawings              # 附图说明
│   └── detailed-description                 # 详细描述（技术细节）
│
├── us-claim-statement                       # 权利要求声明
│                                            # "What is claimed is:"
│
└── claims                                   # 权利要求书 ★★★核心（法律保护范围）
    └── claim                                # 权利要求条目（多个，可能20-30条）
        ├── claim-text                       # 权利要求文本
        └── claim-ref                        # 引用其他权利要求（从属权利要求）
```

#### 二、与外观专利的关键区别

| 对比项 | 发明专利 (Utility) | 外观专利 (Design) |
|-------|-------------------|------------------|
| **根元素** | `us-patent-application` | `us-patent-grant` |
| **专利号** | 纯数字 (20250359498) | D开头 (D1107373) |
| **Kind Code** | A1 (申请公开) | S1 (授权) |
| **申请类型** | `appl-type="utility"` | `appl-type="design"` |
| **分类系统** | **IPC/CPC** (技术领域) | **LOC** (产品品类) |
| **摘要** | **详细摘要**（检索核心） | 无或极简 |
| **说明书** | **几十页技术描述** | 仅图片视角描述 |
| **权利要求** | **多条**（20-30条） | **仅1条**固定格式 |
| **检索核心** | **文本**（摘要+权利要求） | **图片** |
| **专利期** | 20年 | 15年 |

#### 三、索引决策（思考路径）

**决策原则：**
1. **语义检索核心** = 必须向量化
2. **结构化过滤** = 需要索引
3. **展示用途** = 存储但不索引
4. **无业务价值** = 舍弃

| 字段 | XML路径 | 中文含义 | 决策 | 理由 |
|-----|---------|---------|------|------|
| **patent_id** | `doc-number` + `kind` | 专利号 | ✅ **主键** | 唯一标识 |
| **title** | `invention-title` | 发明名称 | ✅ **全文+向量** | 检索核心之一 |
| **abstract** | `abstract/p` | 摘要 | ✅ **向量索引核心** | 语义检索最重要字段 |
| **claims** | `claims/claim/claim-text` | 权利要求 | ✅ **向量索引** | 法律保护范围，侵权判断核心 |
| **ipc_class** | `classifications-ipcr` | IPC分类 | ✅ **结构化索引** | 技术领域过滤核心 |
| **cpc_class** | `classifications-cpc` | CPC分类 | ✅ **结构化索引** | 比IPC更细粒度 |
| **pub_date** | `publication-reference/date` | 公开日期 | ✅ **范围过滤** | 时间筛选 |
| **filing_date** | `application-reference/date` | 申请日期 | ✅ **范围过滤** | 优先权计算 |
| **applicant_name** | `us-applicants/.../orgname` 或 `first-name`+`last-name` | 申请人 | ✅ **全文索引** | 公司检索 |
| **applicant_country** | `us-applicants/.../address/country` | 申请人国家 | ✅ **精确过滤** | 地域筛选 |
| **assignee_name** | `assignees/assignee/.../orgname` | 受让人 | ✅ **全文索引** | 当前权利人 |
| **inventor_name** | `inventors/inventor/.../first-name`+`last-name` | 发明人 | ⚪ 可选索引 | 展示、发明人检索 |
| **description** | `description/p` | 说明书 | ⚪ **可选向量** | 内容太长，可选取部分 |
| **images** | `drawings/figure/img/@file` | 附图文件名 | ⚪ 存储 | 展示用，非检索核心 |
| **us-related-documents** | 整个节点 | 相关文档 | ⚪ 可选存储 | 延续/分案关系 |
| **priority-claims** | 整个节点 | 优先权 | ⚪ 可选存储 | 国际申请追溯 |
| **us-application-series-code** | 整个节点 | 系列号 | ❌ 舍弃 | 内部编号 |

#### 四、特殊发现（5篇对比）

| 发现 | 说明 | 影响 |
|-----|------|------|
| **申请人类型** | US20250359505申请人是公司(orgname)，有些是个人 | 需兼容两种解析 |
| **assignees节点可选** | US20250359550有assignees，其他没有 | 需判空处理 |
| **priority-claims可选** | US20250359520有日本优先权(JP)，US20250359550有临时申请 | 可选字段 |
| **多IPC/CPC分类** | 每个专利有2-5个IPC分类和CPC分类 | 需解析为数组 |
| **多发明人** | US20250359505有2个发明人，US20250359550也有2个 | inventors需解析为数组 |
| **权利要求数量差异** | US20250359505有29条claims，数量差异大 | 拼接时注意长度限制 |
| **说明书长度** | 通常几百行，内容非常丰富 | 向量化时需截断或分段 |

#### 五、向量化策略建议

**摘要+标题** → 拼接后BERT向量化（推荐，长度适中）

**权利要求** → 两种策略：
1. 全部拼接后向量化（可能超长）
2. 只取独立权利要求(claim 1, claim 19等)向量化

**说明书** → 内容太长，建议：
1. 不向量化（使用关键词检索）
2. 或只取SUMMARY部分向量化

### 8.6 专利号类型说明

| Kind Code | 含义 |
|-----------|------|
| A1 | 专利申请公开（未授权） |
| B1 | 授权专利（无之前公开） |
| B2 | 授权专利（有之前公开） |
| **S1** | **外观专利授权** |

---

### 8.6 外观专利文件结构

每个外观专利ZIP包含：
- `.XML` 文件 - 专利数据（结构与发明专利完全不同）
- `.TIF` 文件 - 专利附图（多张，这是**检索核心**）

### 8.7 外观专利 XML 主要结构

```
us-patent-grant                            # 注意：根元素不同！
├── us-bibliographic-data-grant            # 书目数据
│   ├── publication-reference
│   │   ├── doc-number                     # 公开号 (如 D1107373，D开头)
│   │   ├── kind                           # 文献类型 (S1=外观专利授权)
│   │   └── date                           # 公开日期
│   ├── application-reference appl-type="design"  # 申请类型=design
│   ├── us-term-of-grant
│   │   └── length-of-grant                # 专利期限 (通常15年)
│   ├── classification-locarno             # 《====LOC分类（外观专利专用）
│   │   ├── edition                        # 版本
│   │   └── main-classification            # 主分类号 (如 0205)
│   ├── classification-national            # 美国国内分类
│   ├── invention-title                    # 设计名称 (如 "Fabric scarf pin")
│   ├── us-references-cited                # 引用文献
│   └── us-parties                         # 当事人信息
│       ├── us-applicants
│       └── inventors
├── drawings                               # 《======附图列表（检索核心！）
│   └── figure -> img[@file]               # TIF图片文件名
├── description                            # 只有图片描述，非技术说明
│   └── description-of-drawings            # 描述每张图是什么视角
└── claims                                 # 《======只有一条权利要求！
    └── claim-text                         # 如 "The ornamental design for a fabric scarf pin as shown and described."
```

**与发明专利的关键区别：**

| 对比项 | 发明专利 | 外观专利 |
|-------|---------|---------|
| 根元素 | `us-patent-application` | `us-patent-grant` |
| 专利号 | 纯数字 (20250359498) | D开头 (D1107373) |
| Kind Code | A1/B1/B2 | S1 |
| 分类系统 | IPC/CPC | **LOC (Locarno)** |
| 摘要 | 有详细摘要 | **无 abstract 元素** |
| 说明书 | 详细技术描述 | 只有图片视角描述 |
| 权利要求 | 多条详细条款 | **只有一条**，固定格式 |
| 专利期限 | 20年 | **15年** |
| 检索核心 | 文本（摘要、权利要求） | **图片** |

### 8.8 外观专利关键字段提取映射

| 索引字段 | 完整XML路径 | 示例值 | 索引方式 |
|---------|-------------|--------|---------|
| **patent_id** | `/us-patent-grant/us-bibliographic-data-grant/publication-reference/document-id/doc-number` | `D1107373` | 主键 |
| **kind** | 同上 `/kind` | `S1` | 过滤 |
| **title** | `/us-patent-grant/us-bibliographic-data-grant/invention-title` | `Fabric scarf pin` | 全文索引 |
| **loc_class** | `/us-patent-grant/us-bibliographic-data-grant/classification-locarno/main-classification` | `0205` | **结构化过滤** |
| **loc_edition** | 同上 `/edition` | `15` | 存储 |
| **grant_term** | `/us-patent-grant/us-bibliographic-data-grant/us-term-of-grant/length-of-grant` | `15` | 计算到期日 |
| **applicant_name** | `/us-patent-grant/us-bibliographic-data-grant/us-parties/us-applicants/us-applicant/addressbook/first-name` + `last-name` | `Robert Griffin` | 全文索引 |
| **applicant_country** | 同上 `/address/country` | `CA` | 过滤 |
| **filing_date** | `/us-patent-grant/us-bibliographic-data-grant/application-reference/document-id/date` | `20250402` | 范围过滤 |
| **pub_date** | `/us-patent-grant/us-bibliographic-data-grant/publication-reference/document-id/date` | `20251230` | 范围过滤 |
| **images** | `/us-patent-grant/drawings/figure/img/@file` | `USD1107373-20251230-D00001.TIF` | **图片向量检索核心** |
| **claim** | `/us-patent-grant/claims/claim/claim-text` | `The ornamental design for...` | 存储（固定格式，无需向量化） |

### 8.9 外观专利字段解析代码示例

```python
import xml.etree.ElementTree as ET

def parse_design_patent_xml(xml_path):
    """解析USPTO外观专利XML文件"""
    tree = ET.parse(xml_path)
    root = tree.getroot()

    # 书目数据根节点（注意：与发明专利不同！）
    biblio = root.find('us-bibliographic-data-grant')
    pub_ref = biblio.find('publication-reference/document-id')
    app_ref = biblio.find('application-reference/document-id')

    # LOC分类
    loc = biblio.find('classification-locarno')

    # 专利期限
    term = biblio.find('us-term-of-grant/length-of-grant')

    patent = {
        # 公开号 = country + doc-number (D开头)
        'patent_id': f"US{pub_ref.find('doc-number').text}",
        'kind': pub_ref.find('kind').text,  # S1
        'pub_date': pub_ref.find('date').text,
        'filing_date': app_ref.find('date').text,
        'title': biblio.find('invention-title').text,

        # LOC分类（外观专利专用）
        'loc_class': loc.find('main-classification').text if loc is not None else None,
        'loc_edition': loc.find('edition').text if loc is not None else None,

        # 专利期限（通常15年）
        'grant_term': int(term.text) if term is not None else 15,

        # 图片文件名列表（检索核心！）
        'images': [img.get('file') for img in root.findall('.//drawings/figure/img')],

        # 权利要求（外观专利只有一条）
        'claim': root.find('.//claims/claim/claim-text').text,

        # 申请人
        'applicants': [parse_applicant(app) for app in biblio.findall('.//us-applicant')],
    }
    return patent

def parse_applicant(app_node):
    """解析申请人信息"""
    addr = app_node.find('addressbook')
    first = addr.find('first-name')
    last = addr.find('last-name')
    country = addr.find('address/country')
    return {
        'name': f"{first.text if first is not None else ''} {last.text if last is not None else ''}".strip(),
        'country': country.text if country is not None else None
    }
```

### 8.10 LOC分类号含义

LOC (Locarno Classification) 是工业品外观设计的国际分类系统。

以 `02-05` 为例：
- `02` - 大类：服装和服饰用品
- `05` - 小类：纺织品、人造和天然片状材料

常见LOC大类：
| 大类 | 含义 |
|-----|------|
| 01 | 食品 |
| 02 | 服装和服饰用品 |
| 03 | 旅行用品、箱包 |
| 06 | 家具 |
| 07 | 家用器具 |
| 09 | 运输/搬运商品的包装容器 |
| 14 | 录音、通信设备 |
| 21 | 游戏、玩具 |

### 8.11 外观专利XML完整标签解析及索引决策

> 基于5篇实际数据分析：USD1107373, USD1107374, USD1107380, USD1107390, USD1107400, USD1107450

#### 一、XML标签完整列表（中英对照）

```
us-patent-grant                              # 美国授权专利（根元素）
│   属性：lang=语言, country=国家, date-produced=生成日期, date-publ=公开日期
│
├── us-bibliographic-data-grant              # 书目数据（授权专利元数据）
│   │
│   ├── publication-reference                # 公开信息
│   │   └── document-id                      # 文档标识
│   │       ├── country                      # 国家 (US)
│   │       ├── doc-number                   # 专利号 (D1107373，D开头)
│   │       ├── kind                         # 文献类型 (S1=外观专利授权)
│   │       └── date                         # 公开日期 (YYYYMMDD)
│   │
│   ├── application-reference                # 申请信息
│   │   │   属性：appl-type="design"         # 申请类型=外观设计
│   │   └── document-id
│   │       ├── country                      # 国家
│   │       ├── doc-number                   # 申请号
│   │       └── date                         # 申请日期
│   │
│   ├── us-application-series-code           # 申请系列号 (29/35)
│   │
│   ├── priority-claims                      # 优先权声明（可选）
│   │   └── priority-claim
│   │       ├── country                      # 优先权国家 (KR/WO等)
│   │       ├── doc-number                   # 优先权文档号
│   │       └── date                         # 优先权日期
│   │
│   ├── us-term-of-grant                     # 授权期限
│   │   └── length-of-grant                  # 期限长度 (通常15年)
│   │
│   ├── classification-locarno               # LOC洛迦诺分类 ★★★重要
│   │   ├── edition                          # 版本号 (如15)
│   │   └── main-classification              # 主分类号 (如0201, 0204, 0601)
│   │
│   ├── classification-national              # 美国国内分类
│   │   ├── country                          # 国家 (US)
│   │   ├── main-classification              # 主分类 (如 D 2701)
│   │   └── further-classification           # 进一步分类（可选）
│   │
│   ├── invention-title                      # 设计名称 ★★★重要
│   │                                        # 如 "Footwear", "Leisure chair"
│   │
│   ├── us-references-cited                  # 引用文献
│   │   └── us-citation                      # 引用条目（多个，可能数十上百条）
│   │       ├── patcit                       # 专利引用
│   │       │   └── document-id              # 被引专利信息
│   │       │       ├── country, doc-number, kind, name, date
│   │       ├── nplcit                       # 非专利文献引用
│   │       │   └── othercit                 # 其他引用（网页、产品链接等）
│   │       ├── category                     # 引用类别
│   │       │                                # "cited by examiner" / "cited by applicant"
│   │       ├── classification-cpc-text      # CPC分类（可选）
│   │       └── classification-national      # 国内分类（可选）
│   │
│   ├── number-of-claims                     # 权利要求数量 (外观专利=1)
│   ├── us-exemplary-claim                   # 示例权利要求号
│   │
│   ├── us-field-of-classification-search    # 分类检索范围（审查员用）
│   │   ├── classification-national          # 国内分类（多个）
│   │   └── classification-cpc-text          # CPC分类（多个）
│   │
│   ├── figures                              # 附图统计
│   │   ├── number-of-drawing-sheets         # 附图页数
│   │   └── number-of-figures                # 附图数量
│   │
│   ├── us-related-documents                 # 相关文档（可选）
│   │   ├── continuation                     # 延续申请
│   │   ├── continuation-in-part             # 部分延续
│   │   └── division                         # 分案申请
│   │       └── relation
│   │           ├── parent-doc               # 母案
│   │           └── child-doc                # 子案
│   │
│   ├── us-parties                           # 当事人信息 ★★重要
│   │   ├── us-applicants                    # 申请人
│   │   │   └── us-applicant
│   │   │       │ 属性：applicant-authority-category="assignee"(受让人)
│   │   │       ├── addressbook
│   │   │       │   ├── orgname              # 公司名称
│   │   │       │   ├── last-name            # 姓
│   │   │       │   ├── first-name           # 名
│   │   │       │   └── address
│   │   │       │       ├── city             # 城市
│   │   │       │       ├── state            # 州（可选）
│   │   │       │       └── country          # 国家
│   │   │       └── residence                # 居住地
│   │   │
│   │   ├── inventors                        # 发明人/设计师
│   │   │   └── inventor
│   │   │       └── addressbook              # 同上
│   │   │
│   │   └── agents                           # 代理人/律师（可选）
│   │       └── agent
│   │           └── addressbook
│   │               ├── orgname              # 事务所名称
│   │               └── last-name, first-name
│   │
│   ├── assignees                            # 受让人/专利权人（可选）★★重要
│   │   └── assignee
│   │       └── addressbook
│   │           ├── orgname                  # 公司名称
│   │           ├── role                     # 角色代码 (02/03)
│   │           └── address
│   │
│   ├── examiners                            # 审查员
│   │   ├── primary-examiner                 # 主审查员
│   │   │   ├── last-name, first-name
│   │   │   └── department                   # 部门号
│   │   └── assistant-examiner               # 助理审查员（可选）
│   │
│   └── hague-agreement-data                 # 海牙协定数据（国际申请，可选）
│       ├── international-filing-date        # 国际申请日
│       ├── international-registration-publication-date
│       ├── international-registration-number # 国际注册号 (如 DM/242706)
│       └── international-registration-date
│
├── drawings                                 # 附图 ★★★核心
│   └── figure                               # 附图条目（多个）
│       └── img                              # 图片
│           属性：id, he=高度, wi=宽度, file=文件名,
│                 img-content="drawing", img-format="tif"
│                 orientation="landscape"（可选，横向）
│
├── description                              # 描述
│   └── description-of-drawings              # 附图描述
│       └── p                                # 段落（多个）
│           内容：描述每张图的视角
│           如 "FIG. 1 is a front perspective view..."
│
├── us-claim-statement                       # 权利要求声明 ("CLAIM")
│
└── claims                                   # 权利要求书
    └── claim                                # 权利要求条目
        └── claim-text                       # 权利要求文本
            内容固定格式："The ornamental design for a XXX as shown and described."
```

#### 二、索引决策（思考路径）

**决策原则：**
1. **检索核心** = 必须索引（向量化或结构化）
2. **业务筛选** = 需要索引（用于过滤）
3. **展示用途** = 存储但不索引
4. **无业务价值** = 舍弃

| 字段 | XML路径 | 中文含义 | 决策 | 理由 |
|-----|---------|---------|------|------|
| **patent_id** | `doc-number` + `kind` | 专利号 | ✅ **主键** | 唯一标识，必须 |
| **images** | `drawings/figure/img/@file` | 附图文件名 | ✅ **向量索引核心** | 外观检索的核心，必须做图片向量化 |
| **loc_class** | `classification-locarno/main-classification` | LOC分类号 | ✅ **结构化索引** | 产品品类筛选核心 |
| **title** | `invention-title` | 设计名称 | ✅ **全文索引** | 辅助搜索、结果展示 |
| **pub_date** | `publication-reference/date` | 公开日期 | ✅ **范围过滤** | 时间筛选 |
| **filing_date** | `application-reference/date` | 申请日期 | ✅ **范围过滤** | 计算优先权、时间筛选 |
| **grant_term** | `us-term-of-grant/length-of-grant` | 授权期限 | ✅ **存储** | 计算专利到期日（申请日+15年） |
| **applicant_name** | `us-applicants/.../orgname` 或 `first-name`+`last-name` | 申请人 | ✅ **全文索引** | 公司检索、侵权主体识别 |
| **applicant_country** | `us-applicants/.../address/country` | 申请人国家 | ✅ **精确过滤** | 地域筛选 |
| **assignee_name** | `assignees/assignee/.../orgname` | 专利权人 | ✅ **全文索引** | 当前权利人，可能与申请人不同 |
| **inventor_name** | `inventors/inventor/.../first-name`+`last-name` | 设计师 | ⚪ 可选存储 | 展示用，非核心检索 |
| **classification_national** | `classification-national/main-classification` | 美国分类 | ⚪ 可选索引 | 辅助分类，LOC更通用 |
| **claim_text** | `claims/claim/claim-text` | 权利要求文本 | ⚪ 存储不索引 | 固定格式，无需向量化 |
| **number_of_figures** | `figures/number-of-figures` | 附图数量 | ⚪ 存储 | 展示用 |
| **description_of_drawings** | `description/description-of-drawings/p` | 附图描述 | ⚪ 可选存储 | 展示用，说明每张图视角 |
| **examiner** | `examiners/primary-examiner` | 审查员 | ❌ 舍弃 | 对侵权检测无意义 |
| **us-references-cited** | 整个节点 | 引用文献 | ❌ **舍弃** | 数据量大（几十上百条），对外观侵权检测无直接价值 |
| **us-field-of-classification-search** | 整个节点 | 检索范围 | ❌ 舍弃 | 审查员内部使用 |
| **us-related-documents** | 整个节点 | 相关文档 | ❌ 舍弃 | 延续/分案关系复杂，非核心需求 |
| **priority-claims** | 整个节点 | 优先权 | ❌ 舍弃 | 对侵权检测意义不大 |
| **hague-agreement-data** | 整个节点 | 海牙协定 | ❌ 舍弃 | 仅国际申请有，非核心 |
| **agents** | 整个节点 | 代理人 | ❌ 舍弃 | 对业务无意义 |
| **us-application-series-code** | 整个节点 | 系列号 | ❌ 舍弃 | 内部编号 |

#### 三、特殊发现（5篇对比）

| 发现 | 说明 | 影响 |
|-----|------|------|
| **申请人类型不同** | USD1107374申请人是公司(orgname)，USD1107373是个人(first-name+last-name) | 需要兼容两种解析方式 |
| **assignees节点可选** | 部分专利有assignees，部分没有 | 需要判空处理 |
| **priority-claims可选** | USD1107390有韩国优先权，USD1107450有WIPO优先权，大部分没有 | 可选字段 |
| **hague-agreement-data可选** | 仅USD1107390有（国际申请）| 可选字段 |
| **引用文献数量差异大** | USD1107400有100+条引用，USD1107450只有15条 | 数据量大，建议舍弃 |
| **多发明人** | USD1107374有4个发明人 | inventors需要解析为数组 |

## 九、待确认问题

1. ~~USPTO 数据的获取方式？~~ ✅ 已有批量数据
2. ~~预计数据量级？~~ ✅ 数据量较大，需要注意分批导入和索引选择
3. ~~图像向量化用什么模型？~~ ✅ DINOv2（专注几何结构，适合专利线条图）
4. ~~文本向量化用什么模型？~~ ✅ BERT
5. ~~是否需要支持中文专利？~~ ✅ 暂时只做美国专利
6. ~~外观专利数据在哪里？~~ ✅ 已有数据 `数据/I20251230_r1/I20251230/DESIGN/`
7. 实时性要求？（实时索引 vs 批量索引）

## 十、工作流程总结

### 10.1 发明专利处理流程

```
1. 解析 Utility Patent XML
   └── 提取文本字段（标题、摘要、权利要求）
   └── 提取 IPC/CPC 分类
   └── 提取图片路径（辅助展示用）

2. 向量化
   └── 文本 → BERT → 768维向量

3. 存入 Milvus
   └── utility_patent_texts Collection

4. 检索
   └── 用户产品描述 → BERT向量 → 搜索 utility_patent_texts
```

### 10.2 外观专利处理流程

```
1. 解析 Design Patent XML
   └── 提取图片路径（检索核心）
   └── 提取 LOC 分类
   └── 提取基本元数据

2. 向量化
   └── TIF图片 → DINOv2 → 768维向量

3. 存入 Milvus
   └── design_patent_images Collection

4. 检索
   └── 用户商品图片 → CLIP/DINOv2向量 → 搜索 design_patent_images
```

---

## 十一、存储架构设计（MySQL + Milvus）

### 11.1 为什么需要混合架构？

#### 问题分析

我在分析了大量 XML 数据后，发现以下挑战：

| 问题 | 具体表现 | 影响 |
|-----|---------|------|
| **字段不一致** | 有的专利有 `assignees`，有的没有；有的有 `priority-claims`，有的没有 | 无法用固定 Schema |
| **数据类型复杂** | 申请人可能是公司(orgname)或个人(first-name+last-name) | 解析逻辑复杂 |
| **数组字段** | 一个专利有多个 IPC 分类、多个发明人、多张图片 | 需要支持数组/多值 |
| **文本长度差异大** | 权利要求可能 1 条或 30 条，说明书几百行 | 向量化需截断 |
| **Milvus 限制** | 不擅长存储大文本、不支持复杂查询 | 只能存核心字段 |

#### 解决方案：MySQL + Milvus 分工

![image-20260104181230361](D:\work\20251230需求分析\需求分析.assets\image-20260104181230361.png)

#### 分工原则

| 组件 | 存储内容 | 职责 |
|-----|---------|------|
| **Milvus** | 向量 + patent_id + 少量过滤字段 | 向量相似度检索、初步过滤 |
| **MySQL** | 完整元数据（用 JSON 处理可选字段） | 详情存储、复杂查询、数据展示 |

### 11.2 MySQL 表结构设计

#### 11.2.1 发明专利表 (utility_patents)

```sql
CREATE TABLE utility_patents (
    -- 主键
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    patent_id VARCHAR(50) NOT NULL UNIQUE COMMENT '专利号，如 US20250359498A1',

    -- 核心文本字段（检索用）
    title VARCHAR(500) NOT NULL COMMENT '发明名称',
    abstract TEXT COMMENT '摘要（语义检索核心）',
    claims TEXT COMMENT '权利要求（可能很长，20-30条）',

    -- 分类信息（结构化检索）
    ipc_main VARCHAR(20) COMMENT '主IPC分类，如 A61F2/46',
    ipc_classes JSON COMMENT 'IPC分类数组，如 ["A61F2/46", "A61B17/00"]',
    cpc_main VARCHAR(20) COMMENT '主CPC分类',
    cpc_classes JSON COMMENT 'CPC分类数组',

    -- 日期字段（范围过滤）
    pub_date DATE COMMENT '公开日期',
    filing_date DATE COMMENT '申请日期',

    -- 当事人信息（用 JSON 处理不一致结构）
    applicants JSON COMMENT '申请人数组，如 [{"name":"Apple Inc","country":"US","type":"company"}]',
    inventors JSON COMMENT '发明人数组，如 [{"name":"John Smith","country":"US"}]',
    assignees JSON COMMENT '受让人数组（可选，可能为空）',

    -- 可选字段（有些专利有，有些没有）
    priority_claims JSON COMMENT '优先权声明（可选）',
    related_documents JSON COMMENT '相关文档（可选）',

    -- 图片信息
    images JSON COMMENT '图片文件名数组',
    image_count INT DEFAULT 0 COMMENT '图片数量',

    -- 元信息
    kind VARCHAR(5) COMMENT '文献类型：A1/B1/B2',
    country VARCHAR(5) DEFAULT 'US' COMMENT '国家',
    xml_path VARCHAR(500) COMMENT '原始XML文件路径',

    -- 系统字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引
    INDEX idx_pub_date (pub_date),
    INDEX idx_filing_date (filing_date),
    INDEX idx_ipc_main (ipc_main),
    INDEX idx_cpc_main (cpc_main),
    INDEX idx_country (country),
    FULLTEXT INDEX idx_title_ft (title),
    FULLTEXT INDEX idx_abstract_ft (abstract)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='发明专利元数据表';
```

#### 11.2.2 外观专利表 (design_patents)

```sql
CREATE TABLE design_patents (
    -- 主键
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    patent_id VARCHAR(50) NOT NULL UNIQUE COMMENT '专利号，如 USD1107373',

    -- 核心字段
    title VARCHAR(500) COMMENT '设计名称，如 Footwear',
    claim_text TEXT COMMENT '权利要求（通常只有一句话）',

    -- 分类信息（LOC分类）
    loc_class VARCHAR(20) COMMENT 'LOC分类号，如 0201',
    loc_edition VARCHAR(5) COMMENT 'LOC版本，如 15',
    us_class_main VARCHAR(20) COMMENT '美国分类主号，如 D 2/701',
    us_classes JSON COMMENT '美国分类数组',

    -- 日期字段
    pub_date DATE COMMENT '公开日期',
    filing_date DATE COMMENT '申请日期',
    grant_term INT DEFAULT 15 COMMENT '授权期限（年）',
    expiry_date DATE COMMENT '到期日期（计算得出）',

    -- 当事人信息（用 JSON 处理）
    applicants JSON COMMENT '申请人数组',
    inventors JSON COMMENT '设计师数组',
    assignees JSON COMMENT '受让人数组（可选）',

    -- 图片信息（外观专利核心）
    images JSON COMMENT '图片文件名数组',
    image_count INT DEFAULT 0 COMMENT '图片数量',
    drawing_description TEXT COMMENT '附图描述（各视角说明）',

    -- 元信息
    kind VARCHAR(5) DEFAULT 'S1' COMMENT '文献类型：S1',
    country VARCHAR(5) DEFAULT 'US' COMMENT '国家',
    xml_path VARCHAR(500) COMMENT '原始XML文件路径',

    -- 系统字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引
    INDEX idx_pub_date (pub_date),
    INDEX idx_filing_date (filing_date),
    INDEX idx_loc_class (loc_class),
    INDEX idx_expiry_date (expiry_date),
    FULLTEXT INDEX idx_title_ft (title)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='外观专利元数据表';
```

#### 11.2.3 图片向量关联表 (design_patent_images)

> 因为一个外观专利有多张图片，每张图片都需要向量化，所以单独建表

```sql
CREATE TABLE design_patent_images (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    patent_id VARCHAR(50) NOT NULL COMMENT '关联专利号',
    image_index INT NOT NULL COMMENT '图片序号（0开始）',
    image_file VARCHAR(200) NOT NULL COMMENT '图片文件名',
    image_description VARCHAR(500) COMMENT '图片描述，如 FIG. 1 is a front view',
    milvus_id BIGINT COMMENT 'Milvus中的向量ID（可选）',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_patent_id (patent_id),
    UNIQUE KEY uk_patent_image (patent_id, image_index)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='外观专利图片表';
```

### 11.3 Milvus Collection 设计（精简版）

> 原则：Milvus 只存向量检索必需的字段，其他全部放 MySQL

#### 11.3.1 发明专利文本向量 Collection

```python
from pymilvus import CollectionSchema, FieldSchema, DataType

# 发明专利 - 文本向量
utility_patent_vectors = CollectionSchema(
    fields=[
        FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
        FieldSchema(name="patent_id", dtype=DataType.VARCHAR, max_length=50),

        # 文本向量（BERT输出）
        FieldSchema(name="text_vector", dtype=DataType.FLOAT_VECTOR, dim=768),

        # 只保留最常用的过滤字段
        FieldSchema(name="ipc_main", dtype=DataType.VARCHAR, max_length=20),
        FieldSchema(name="pub_date", dtype=DataType.INT64),  # YYYYMMDD 格式
    ],
    description="发明专利文本向量"
)

# 索引配置
index_params = {
    "metric_type": "IP",  # 内积，适合归一化向量
    "index_type": "IVF_FLAT",
    "params": {"nlist": 1024}
}
```

#### 11.3.2 外观专利图片向量 Collection

```python
# 外观专利 - 图片向量
design_patent_vectors = CollectionSchema(
    fields=[
        FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
        FieldSchema(name="patent_id", dtype=DataType.VARCHAR, max_length=50),
        FieldSchema(name="image_index", dtype=DataType.INT16),  # 第几张图

        # 图片向量（DINOv2输出）
        FieldSchema(name="image_vector", dtype=DataType.FLOAT_VECTOR, dim=768),  # DINOv2 ViT-B/14

        # 只保留最常用的过滤字段
        FieldSchema(name="loc_class", dtype=DataType.VARCHAR, max_length=20),
        FieldSchema(name="pub_date", dtype=DataType.INT64),
    ],
    description="外观专利图片向量"
)
```

### 11.4 XML 解析策略（处理字段不一致）

#### 11.4.1 核心思想：防御性解析

```python
def safe_get_text(element, path, default=''):
    """安全获取XML元素文本，不存在返回默认值"""
    node = element.find(path)
    return node.text.strip() if node is not None and node.text else default

def safe_get_attr(element, path, attr, default=''):
    """安全获取XML元素属性"""
    node = element.find(path)
    return node.get(attr, default) if node is not None else default

def safe_get_list(element, path, parser_func):
    """安全获取列表，不存在返回空列表"""
    nodes = element.findall(path)
    return [parser_func(node) for node in nodes] if nodes else []
```

#### 11.4.2 发明专利解析器

```python
import xml.etree.ElementTree as ET
import json
from datetime import datetime

class UtilityPatentParser:
    """发明专利XML解析器"""

    def parse(self, xml_path: str) -> dict:
        """解析发明专利XML，返回字典"""
        tree = ET.parse(xml_path)
        root = tree.getroot()

        # 书目数据根节点
        biblio = root.find('us-bibliographic-data-application')
        if biblio is None:
            raise ValueError(f"无效的发明专利XML: {xml_path}")

        pub_ref = biblio.find('publication-reference/document-id')
        app_ref = biblio.find('application-reference/document-id')

        patent = {
            # === 必需字段 ===
            'patent_id': self._build_patent_id(pub_ref),
            'title': safe_get_text(biblio, 'invention-title'),
            'abstract': self._parse_abstract(root),
            'claims': self._parse_claims(root),

            # === 分类信息 ===
            'ipc_classes': self._parse_ipc_classes(biblio),
            'ipc_main': None,  # 后面取第一个
            'cpc_classes': self._parse_cpc_classes(biblio),
            'cpc_main': None,

            # === 日期 ===
            'pub_date': self._parse_date(safe_get_text(pub_ref, 'date')),
            'filing_date': self._parse_date(safe_get_text(app_ref, 'date')),

            # === 当事人（可选字段，用防御性解析）===
            'applicants': self._parse_applicants(biblio),
            'inventors': self._parse_inventors(biblio),
            'assignees': self._parse_assignees(biblio),  # 可能为空

            # === 可选信息 ===
            'priority_claims': self._parse_priority_claims(biblio),
            'related_documents': self._parse_related_docs(biblio),

            # === 图片 ===
            'images': self._parse_images(root),
            'image_count': 0,

            # === 元信息 ===
            'kind': safe_get_text(pub_ref, 'kind'),
            'country': safe_get_text(pub_ref, 'country', 'US'),
            'xml_path': xml_path,
        }

        # 填充计算字段
        if patent['ipc_classes']:
            patent['ipc_main'] = patent['ipc_classes'][0]
        if patent['cpc_classes']:
            patent['cpc_main'] = patent['cpc_classes'][0]
        patent['image_count'] = len(patent['images'])

        return patent

    def _build_patent_id(self, pub_ref) -> str:
        """构建专利号: US + doc-number + kind"""
        country = safe_get_text(pub_ref, 'country', 'US')
        doc_num = safe_get_text(pub_ref, 'doc-number')
        kind = safe_get_text(pub_ref, 'kind')
        return f"{country}{doc_num}{kind}"

    def _parse_abstract(self, root) -> str:
        """解析摘要（多个段落拼接）"""
        paragraphs = root.findall('.//abstract/p')
        texts = []
        for p in paragraphs:
            # 获取元素内所有文本（包括子元素）
            text = ''.join(p.itertext())
            if text:
                texts.append(text.strip())
        return ' '.join(texts)

    def _parse_claims(self, root) -> str:
        """解析权利要求（多条拼接）"""
        claims = root.findall('.//claims/claim')
        texts = []
        for claim in claims:
            # 递归获取所有文本
            text = ''.join(claim.itertext())
            if text:
                texts.append(text.strip())
        return '\n\n'.join(texts)

    def _parse_ipc_classes(self, biblio) -> list:
        """解析IPC分类号列表"""
        ipc_nodes = biblio.findall('.//classification-ipcr')
        classes = []
        for ipc in ipc_nodes:
            section = safe_get_text(ipc, 'section')
            cls = safe_get_text(ipc, 'class')
            subcls = safe_get_text(ipc, 'subclass')
            main_group = safe_get_text(ipc, 'main-group')
            subgroup = safe_get_text(ipc, 'subgroup')
            if section and cls:
                ipc_str = f"{section}{cls}{subcls}{main_group}/{subgroup}"
                classes.append(ipc_str)
        return classes

    def _parse_cpc_classes(self, biblio) -> list:
        """解析CPC分类号列表"""
        cpc_nodes = biblio.findall('.//classification-cpc')
        classes = []
        for cpc in cpc_nodes:
            section = safe_get_text(cpc, 'section')
            cls = safe_get_text(cpc, 'class')
            subcls = safe_get_text(cpc, 'subclass')
            main_group = safe_get_text(cpc, 'main-group')
            subgroup = safe_get_text(cpc, 'subgroup')
            if section and cls:
                cpc_str = f"{section}{cls}{subcls}{main_group}/{subgroup}"
                classes.append(cpc_str)
        return classes

    def _parse_applicants(self, biblio) -> list:
        """解析申请人（兼容公司和个人）"""
        applicants = []
        for app in biblio.findall('.//us-applicant'):
            addr = app.find('addressbook')
            if addr is None:
                continue

            # 公司名称
            orgname = safe_get_text(addr, 'orgname')
            # 个人名称
            first = safe_get_text(addr, 'first-name')
            last = safe_get_text(addr, 'last-name')
            # 国家
            country = safe_get_text(addr, 'address/country')

            if orgname:
                applicants.append({
                    'name': orgname,
                    'country': country,
                    'type': 'company'
                })
            elif first or last:
                applicants.append({
                    'name': f"{first} {last}".strip(),
                    'country': country,
                    'type': 'individual'
                })
        return applicants

    def _parse_inventors(self, biblio) -> list:
        """解析发明人"""
        inventors = []
        for inv in biblio.findall('.//inventor'):
            addr = inv.find('addressbook')
            if addr is None:
                continue
            first = safe_get_text(addr, 'first-name')
            last = safe_get_text(addr, 'last-name')
            country = safe_get_text(addr, 'address/country')
            if first or last:
                inventors.append({
                    'name': f"{first} {last}".strip(),
                    'country': country
                })
        return inventors

    def _parse_assignees(self, biblio) -> list:
        """解析受让人（可选字段）"""
        assignees = []
        for asn in biblio.findall('.//assignee'):
            addr = asn.find('addressbook')
            if addr is None:
                continue
            orgname = safe_get_text(addr, 'orgname')
            country = safe_get_text(addr, 'address/country')
            if orgname:
                assignees.append({
                    'name': orgname,
                    'country': country
                })
        return assignees  # 可能为空列表

    def _parse_priority_claims(self, biblio) -> list:
        """解析优先权（可选字段）"""
        claims = []
        for pc in biblio.findall('.//priority-claim'):
            country = safe_get_text(pc, 'country')
            doc_num = safe_get_text(pc, 'doc-number')
            date = safe_get_text(pc, 'date')
            if country and doc_num:
                claims.append({
                    'country': country,
                    'doc_number': doc_num,
                    'date': date
                })
        return claims  # 可能为空

    def _parse_related_docs(self, biblio) -> list:
        """解析相关文档（可选字段）"""
        docs = []
        for rel in biblio.findall('.//us-related-documents/*'):
            doc_type = rel.tag  # continuation, us-provisional-application 等
            doc_id = rel.find('.//document-id')
            if doc_id is not None:
                docs.append({
                    'type': doc_type,
                    'country': safe_get_text(doc_id, 'country'),
                    'doc_number': safe_get_text(doc_id, 'doc-number'),
                    'date': safe_get_text(doc_id, 'date')
                })
        return docs

    def _parse_images(self, root) -> list:
        """解析图片列表"""
        images = []
        for img in root.findall('.//drawings/figure/img'):
            file_name = img.get('file')
            if file_name:
                images.append(file_name)
        return images

    def _parse_date(self, date_str: str):
        """解析日期字符串 YYYYMMDD -> date对象"""
        if not date_str or len(date_str) != 8:
            return None
        try:
            return datetime.strptime(date_str, '%Y%m%d').date()
        except:
            return None
```

#### 11.4.3 外观专利解析器

```python
class DesignPatentParser:
    """外观专利XML解析器"""

    def parse(self, xml_path: str) -> dict:
        """解析外观专利XML"""
        tree = ET.parse(xml_path)
        root = tree.getroot()

        # 注意：外观专利根元素是 us-patent-grant
        biblio = root.find('us-bibliographic-data-grant')
        if biblio is None:
            raise ValueError(f"无效的外观专利XML: {xml_path}")

        pub_ref = biblio.find('publication-reference/document-id')
        app_ref = biblio.find('application-reference/document-id')

        patent = {
            # === 必需字段 ===
            'patent_id': self._build_patent_id(pub_ref),
            'title': safe_get_text(biblio, 'invention-title'),
            'claim_text': self._parse_claim(root),

            # === LOC分类 ===
            'loc_class': self._parse_loc_class(biblio),
            'loc_edition': self._parse_loc_edition(biblio),
            'us_class_main': self._parse_us_class(biblio),
            'us_classes': self._parse_us_classes(biblio),

            # === 日期 ===
            'pub_date': self._parse_date(safe_get_text(pub_ref, 'date')),
            'filing_date': self._parse_date(safe_get_text(app_ref, 'date')),
            'grant_term': self._parse_grant_term(biblio),
            'expiry_date': None,  # 后面计算

            # === 当事人 ===
            'applicants': self._parse_applicants(biblio),
            'inventors': self._parse_inventors(biblio),
            'assignees': self._parse_assignees(biblio),

            # === 图片（核心）===
            'images': self._parse_images(root),
            'image_count': 0,
            'drawing_description': self._parse_drawing_description(root),

            # === 元信息 ===
            'kind': safe_get_text(pub_ref, 'kind', 'S1'),
            'country': safe_get_text(pub_ref, 'country', 'US'),
            'xml_path': xml_path,
        }

        # 计算字段
        patent['image_count'] = len(patent['images'])
        patent['expiry_date'] = self._calc_expiry_date(
            patent['filing_date'],
            patent['grant_term']
        )

        return patent

    def _build_patent_id(self, pub_ref) -> str:
        """构建专利号: US + D + number"""
        country = safe_get_text(pub_ref, 'country', 'US')
        doc_num = safe_get_text(pub_ref, 'doc-number')  # D1107373
        return f"{country}{doc_num}"

    def _parse_claim(self, root) -> str:
        """解析权利要求（外观专利通常只有一条）"""
        claim = root.find('.//claims/claim/claim-text')
        if claim is not None:
            return ''.join(claim.itertext()).strip()
        return ''

    def _parse_loc_class(self, biblio) -> str:
        """解析LOC分类号"""
        loc = biblio.find('.//classification-locarno/main-classification')
        return loc.text.strip() if loc is not None and loc.text else ''

    def _parse_loc_edition(self, biblio) -> str:
        """解析LOC版本"""
        edition = biblio.find('.//classification-locarno/edition')
        return edition.text.strip() if edition is not None and edition.text else ''

    def _parse_us_class(self, biblio) -> str:
        """解析美国分类主号"""
        us_class = biblio.find('.//classification-national/main-classification')
        return us_class.text.strip() if us_class is not None and us_class.text else ''

    def _parse_us_classes(self, biblio) -> list:
        """解析美国分类列表"""
        classes = []
        main = self._parse_us_class(biblio)
        if main:
            classes.append(main)
        for fc in biblio.findall('.//classification-national/further-classification'):
            if fc.text:
                classes.append(fc.text.strip())
        return classes

    def _parse_grant_term(self, biblio) -> int:
        """解析授权期限"""
        term = biblio.find('.//us-term-of-grant/length-of-grant')
        if term is not None and term.text:
            try:
                return int(term.text)
            except:
                pass
        return 15  # 默认15年

    def _parse_drawing_description(self, root) -> str:
        """解析附图描述"""
        paragraphs = root.findall('.//description/description-of-drawings/p')
        texts = []
        for p in paragraphs:
            text = ''.join(p.itertext())
            if text:
                texts.append(text.strip())
        return '\n'.join(texts)

    def _calc_expiry_date(self, filing_date, grant_term):
        """计算到期日期"""
        if filing_date and grant_term:
            from dateutil.relativedelta import relativedelta
            return filing_date + relativedelta(years=grant_term)
        return None

    # 复用发明专利的方法
    _parse_applicants = UtilityPatentParser._parse_applicants
    _parse_inventors = UtilityPatentParser._parse_inventors
    _parse_assignees = UtilityPatentParser._parse_assignees
    _parse_images = UtilityPatentParser._parse_images
    _parse_date = UtilityPatentParser._parse_date
```

### 11.5 数据导入流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据导入流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 扫描数据目录                                                │
│      │                                                          │
│      ├── 发明专利: 数据/I20251127/I20251127/UTIL*/              │
│      └── 外观专利: 数据/I20251230_r1/I20251230/DESIGN/          │
│                                                                 │
│   2. 解析 XML                                                    │
│      │                                                          │
│      ├── 识别专利类型（根元素不同）                               │
│      ├── 调用对应解析器                                          │
│      └── 防御性处理缺失字段                                       │
│                                                                 │
│   3. 存储到 MySQL                                                │
│      │                                                          │
│      ├── JSON 字段直接 json.dumps()                             │
│      ├── 日期字段转换                                            │
│      └── 批量插入（每批 1000 条）                                 │
│                                                                 │
│   4. 向量化 & 存储到 Milvus                                      │
│      │                                                          │
│      ├── 发明专利: 摘要+标题 → BERT → text_vector               │
│      ├── 外观专利: 每张图片 → CLIP/ → image_vector               │
│      └── 批量插入（每批 10000 条）                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 导入脚本示例

```python
import os
import json
from pathlib import Path
import mysql.connector
from pymilvus import connections, Collection

class PatentImporter:
    """专利数据导入器"""

    def __init__(self, mysql_config, milvus_config):
        self.mysql_conn = mysql.connector.connect(**mysql_config)
        connections.connect(**milvus_config)

        self.utility_parser = UtilityPatentParser()
        self.design_parser = DesignPatentParser()

        # 向量化模型（后续实现）
        self.bert_model = None  # BERTVectorizer()
        self.dinov2_model = None  # DINOv2Vectorizer()

    def import_utility_patents(self, data_dir: str, batch_size=1000):
        """导入发明专利"""
        xml_files = list(Path(data_dir).rglob('*.XML'))
        print(f"发现 {len(xml_files)} 个发明专利XML文件")

        batch = []
        for xml_path in xml_files:
            try:
                patent = self.utility_parser.parse(str(xml_path))
                batch.append(patent)

                if len(batch) >= batch_size:
                    self._save_utility_batch_to_mysql(batch)
                    self._save_utility_batch_to_milvus(batch)
                    batch = []

            except Exception as e:
                print(f"解析失败: {xml_path}, 错误: {e}")

        # 处理剩余
        if batch:
            self._save_utility_batch_to_mysql(batch)
            self._save_utility_batch_to_milvus(batch)

    def _save_utility_batch_to_mysql(self, patents: list):
        """批量保存发明专利到MySQL"""
        cursor = self.mysql_conn.cursor()

        sql = """
        INSERT INTO utility_patents
        (patent_id, title, abstract, claims, ipc_main, ipc_classes, cpc_main, cpc_classes,
         pub_date, filing_date, applicants, inventors, assignees, priority_claims,
         related_documents, images, image_count, kind, country, xml_path)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        ON DUPLICATE KEY UPDATE updated_at=NOW()
        """

        values = []
        for p in patents:
            values.append((
                p['patent_id'],
                p['title'],
                p['abstract'],
                p['claims'],
                p['ipc_main'],
                json.dumps(p['ipc_classes']),
                p['cpc_main'],
                json.dumps(p['cpc_classes']),
                p['pub_date'],
                p['filing_date'],
                json.dumps(p['applicants']),
                json.dumps(p['inventors']),
                json.dumps(p['assignees']) if p['assignees'] else None,
                json.dumps(p['priority_claims']) if p['priority_claims'] else None,
                json.dumps(p['related_documents']) if p['related_documents'] else None,
                json.dumps(p['images']),
                p['image_count'],
                p['kind'],
                p['country'],
                p['xml_path'],
            ))

        cursor.executemany(sql, values)
        self.mysql_conn.commit()
        print(f"MySQL: 已保存 {len(patents)} 条发明专利")

    def _save_utility_batch_to_milvus(self, patents: list):
        """批量保存发明专利向量到Milvus"""
        collection = Collection("utility_patent_vectors")

        # 向量化
        texts = [f"{p['title']} {p['abstract']}" for p in patents]
        vectors = self.bert_model.encode(texts)  # 假设返回 numpy array

        # 准备数据
        data = [
            [p['patent_id'] for p in patents],
            vectors.tolist(),
            [p['ipc_main'] or '' for p in patents],
            [int(p['pub_date'].strftime('%Y%m%d')) if p['pub_date'] else 0 for p in patents],
        ]

        collection.insert(data)
        print(f"Milvus: 已保存 {len(patents)} 条发明专利向量")
```

### 11.6 检索流程（完整业务说明）

#### 11.6.1 外观专利检索（以图搜图）

**业务场景**：跨境卖家上传一张商品图片，检测是否侵犯外观专利

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        外观专利检索完整流程                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【前端】                                                                │
│     │                                                                   │
│     │  1. 用户上传商品图片（实物照片）                                    │
│     │  2. 可选：选择商品品类（LOC分类）、上架国家                          │
│     │  3. 点击"检测侵权风险"                                             │
│     │                                                                   │
│     ▼                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【后端 API】POST /api/search/design                                    │
│     │                                                                   │
│     │  接收参数：                                                        │
│     │  - image: 商品图片文件                                             │
│     │  - loc_class: LOC分类（可选，缩小搜索范围）                         │
│     │  - top_k: 返回数量（默认20）                                       │
│     │                                                                   │
│     ▼                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【搜索服务】                                                            │
│     │                                                                   │
│     │  Step 1: 图片向量化                                               │
│     │     └── 用户上传的实物图 → DINOv2 模型 → 512维向量                 │
│     │         （DINOv2专注几何结构，能匹配实物图和专利线条图）             │
│     │                                                                   │
│     │  Step 2: Milvus 向量检索                                          │
│     │     └── 输入：图片向量 + 过滤条件（loc_class）                      │
│     │     └── 在 design_patent_vectors 中搜索相似向量                    │
│     │     └── 输出：Top-K 个 (patent_id, image_index, 相似度分数)        │
│     │     └── 耗时：约 10-50ms                                          │
│     │                                                                   │
│     │  Step 3: 去重 & 聚合                                              │
│     │     └── 同一专利多张图片，取最高相似度分数                          │
│     │     └── 得到专利级别的排序结果                                     │
│     │                                                                   │
│     │  Step 4: MySQL 查询详情                                           │
│     │     └── 用 patent_id 列表查询 design_patents 表                   │
│     │     └── 获取：标题、申请人、到期日、所有图片路径等                   │
│     │     └── 耗时：约 5ms                                              │
│     │                                                                   │
│     │  Step 5: 风险等级计算                                             │
│     │     └── 相似度 > 0.85 → 高风险（红色警告）                         │
│     │     └── 相似度 0.70-0.85 → 中风险（黄色警告）                      │
│     │     └── 相似度 < 0.70 → 低风险（绿色）                             │
│     │                                                                   │
│     ▼                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【后端返回】                                                            │
│     │                                                                   │
│     │  {                                                                │
│     │    "total": 20,                                                   │
│     │    "risk_summary": {"high": 2, "medium": 5, "low": 13},          │
│     │    "results": [                                                   │
│     │      {                                                            │
│     │        "patent_id": "USD1107373",                                 │
│     │        "title": "Footwear",                                       │
│     │        "similarity_score": 0.92,                                  │
│     │        "risk_level": "high",                                      │
│     │        "applicant": "Nike Inc",                                   │
│     │        "expiry_date": "2040-04-02",                               │
│     │        "matched_image": "USD1107373-D00003.TIF",                  │
│     │        "all_images": ["D00001.TIF", "D00002.TIF", ...]            │
│     │      },                                                           │
│     │      ...                                                          │
│     │    ]                                                              │
│     │  }                                                                │
│     │                                                                   │
│     ▼                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【前端展示】                                                            │
│     │                                                                   │
│     │  1. 顶部显示风险概览：高风险 2 个 / 中风险 5 个 / 低风险 13 个      │
│     │  2. 列表展示匹配的专利：                                           │
│     │     - 左侧：用户上传的商品图                                        │
│     │     - 右侧：匹配到的专利图（相似度最高的那张）                       │
│     │     - 相似度百分比 + 风险标签                                       │
│     │     - 专利基本信息（专利号、申请人、到期日）                         │
│     │  3. 点击可查看专利详情页                                           │
│     │                                                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 11.6.2 发明专利检索（以文搜文）

**业务场景**：卖家输入产品标题和描述，检测是否侵犯发明专利

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        发明专利检索完整流程                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【前端】                                                                │
│     │                                                                   │
│     │  1. 用户输入产品标题："Wireless Bluetooth Earbuds with Charging    │
│     │     Case"                                                         │
│     │  2. 用户输入产品描述："TWS earbuds with active noise cancellation,│
│     │     touch control, 30-hour battery life..."                       │
│     │  3. 可选：选择技术领域（IPC分类）                                   │
│     │  4. 点击"检测侵权风险"                                             │
│     │                                                                   │
│     ▼                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【后端 API】POST /api/search/utility                                   │
│     │                                                                   │
│     │  接收参数：                                                        │
│     │  - title: 产品标题                                                │
│     │  - description: 产品描述                                          │
│     │  - ipc_class: IPC分类（可选）                                     │
│     │  - top_k: 返回数量（默认20）                                       │
│     │                                                                   │
│     ▼                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【搜索服务】                                                            │
│     │                                                                   │
│     │  Step 1: 文本预处理                                               │
│     │     └── 拼接：title + description                                 │
│     │     └── 清洗：去除特殊字符、统一小写                               │
│     │                                                                   │
│     │  Step 2: 文本向量化                                               │
│     │     └── 预处理后的文本 → BERT 模型 → 768维向量                     │
│     │         （BERT理解语义，"earbuds"能匹配"earphone"）                │
│     │                                                                   │
│     │  Step 3: Milvus 向量检索                                          │
│     │     └── 输入：文本向量 + 过滤条件（ipc_class）                      │
│     │     └── 在 utility_patent_vectors 中搜索相似向量                   │
│     │     └── 输出：Top-K 个 (patent_id, 相似度分数)                     │
│     │     └── 耗时：约 10-50ms                                          │
│     │                                                                   │
│     │  Step 4: MySQL 查询详情                                           │
│     │     └── 用 patent_id 列表查询 utility_patents 表                  │
│     │     └── 获取：标题、摘要、权利要求、申请人、IPC分类等               │
│     │     └── 耗时：约 5ms                                              │
│     │                                                                   │
│     │  Step 5: 风险分析                                                 │
│     │     └── 计算相似度等级                                            │
│     │     └── 提取匹配的关键技术点（高亮显示）                            │
│     │                                                                   │
│     ▼                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【后端返回】                                                            │
│     │                                                                   │
│     │  {                                                                │
│     │    "total": 20,                                                   │
│     │    "risk_summary": {"high": 1, "medium": 3, "low": 16},          │
│     │    "results": [                                                   │
│     │      {                                                            │
│     │        "patent_id": "US20250359498A1",                            │
│     │        "title": "Wireless Earphone with Noise Cancellation",     │
│     │        "abstract": "A wireless earphone comprising...",           │
│     │        "similarity_score": 0.88,                                  │
│     │        "risk_level": "high",                                      │
│     │        "applicant": "Apple Inc",                                  │
│     │        "ipc_class": "H04R1/10",                                   │
│     │        "matched_claims": ["claim 1", "claim 5"]                   │
│     │      },                                                           │
│     │      ...                                                          │
│     │    ]                                                              │
│     │  }                                                                │
│     │                                                                   │
│     ▼                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【前端展示】                                                            │
│     │                                                                   │
│     │  1. 顶部显示风险概览                                               │
│     │  2. 列表展示匹配的专利：                                           │
│     │     - 专利标题 + 摘要（关键词高亮）                                 │
│     │     - 相似度百分比 + 风险标签                                       │
│     │     - 涉及的权利要求条款                                           │
│     │  3. 点击可查看专利全文（五书）                                      │
│     │                                                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 11.6.3 流程简化总结

**外观专利检索（一句话）**：

> 用户上传商品图 → DINOv2提取几何特征向量 → Milvus找相似专利图向量 → MySQL取专利详情 → 返回风险排序结果

**发明专利检索（一句话）**：

> 用户输入产品描述 → BERT提取语义向量 → Milvus找相似专利摘要向量 → MySQL取专利详情 → 返回风险排序结果

#### 11.6.4 为什么图片用 DINOv2 而不是 CLIP？

| 模型 | 特点 | 适用场景 |
|-----|------|---------|
| **CLIP** | 图文对齐，理解"这是一个杯子" | 实物图搜实物图 |
| **DINOv2** | 自监督学习，关注**几何结构**，忽略纹理颜色 | **专利线条图** |

专利外观图的特点：
- 黑白线条图，无颜色
- 只有轮廓和结构
- 需要匹配"形状相似"而非"颜色相似"

DINOv2 完美契合这个需求，因为它：
1. 不依赖纹理（专利图没有纹理）
2. 专注几何结构（这正是外观专利保护的内容）
3. 能跨域匹配（实物照片 ↔ 线条图）

```python
class PatentSearcher:
    """专利检索器"""

    def search_by_image(self, image_path: str, top_k=20, loc_class=None) -> list:
        """外观专利检索（以图搜图）"""

        # 1. 图片向量化
        image_vector = self.dinov2_model.encode_image(image_path)

        # 2. Milvus 检索
        collection = Collection("design_patent_vectors")
        collection.load()

        search_params = {"metric_type": "IP", "params": {"nprobe": 10}}

        # 构建过滤表达式
        expr = None
        if loc_class:
            expr = f'loc_class == "{loc_class}"'

        results = collection.search(
            data=[image_vector.tolist()],
            anns_field="image_vector",
            param=search_params,
            limit=top_k,
            expr=expr,
            output_fields=["patent_id", "image_index"]
        )

        # 3. 提取 patent_id 和分数
        patent_scores = {}
        for hit in results[0]:
            pid = hit.entity.get('patent_id')
            score = hit.score
            # 同一专利多张图片，取最高分
            if pid not in patent_scores or score > patent_scores[pid]:
                patent_scores[pid] = score

        # 4. MySQL 查询详情
        patent_ids = list(patent_scores.keys())
        details = self._get_design_patents_from_mysql(patent_ids)

        # 5. 组装结果
        results = []
        for patent in details:
            patent['similarity_score'] = patent_scores.get(patent['patent_id'], 0)
            results.append(patent)

        # 按分数排序
        results.sort(key=lambda x: x['similarity_score'], reverse=True)
        return results

    def search_by_text(self, description: str, top_k=20, ipc_class=None) -> list:
        """发明专利检索（以文搜文）"""

        # 1. 文本向量化
        text_vector = self.bert_model.encode(description)

        # 2. Milvus 检索
        collection = Collection("utility_patent_vectors")
        collection.load()

        expr = None
        if ipc_class:
            expr = f'ipc_main like "{ipc_class}%"'

        results = collection.search(
            data=[text_vector.tolist()],
            anns_field="text_vector",
            param={"metric_type": "IP", "params": {"nprobe": 10}},
            limit=top_k,
            expr=expr,
            output_fields=["patent_id"]
        )

        # 3. 提取结果
        patent_scores = {hit.entity.get('patent_id'): hit.score for hit in results[0]}

        # 4. MySQL 查询详情
        patent_ids = list(patent_scores.keys())
        details = self._get_utility_patents_from_mysql(patent_ids)

        # 5. 组装结果
        for patent in details:
            patent['similarity_score'] = patent_scores.get(patent['patent_id'], 0)

        details.sort(key=lambda x: x['similarity_score'], reverse=True)
        return details

    def _get_design_patents_from_mysql(self, patent_ids: list) -> list:
        """从MySQL获取外观专利详情"""
        if not patent_ids:
            return []

        cursor = self.mysql_conn.cursor(dictionary=True)
        placeholders = ','.join(['%s'] * len(patent_ids))
        sql = f"""
        SELECT patent_id, title, claim_text, loc_class, pub_date, filing_date,
               expiry_date, applicants, inventors, assignees, images, image_count
        FROM design_patents
        WHERE patent_id IN ({placeholders})
        """
        cursor.execute(sql, patent_ids)
        results = cursor.fetchall()

        # JSON 字段反序列化
        for r in results:
            for field in ['applicants', 'inventors', 'assignees', 'images']:
                if r[field]:
                    r[field] = json.loads(r[field])

        return results
```

### 11.7 总结：字段存储位置一览

#### 发明专利

| 字段 | MySQL | Milvus | 说明 |
|-----|-------|--------|------|
| patent_id | ✅ 主键 | ✅ 关联键 | 两边都需要 |
| title | ✅ | ❌ | MySQL存储，向量化时拼接 |
| abstract | ✅ | ❌ | MySQL存储，向量化时使用 |
| claims | ✅ | ❌ | 太长，只存MySQL |
| **text_vector** | ❌ | ✅ | 只存Milvus |
| ipc_main | ✅ | ✅ | 两边都需要（过滤用） |
| ipc_classes | ✅ JSON | ❌ | 完整列表只存MySQL |
| pub_date | ✅ | ✅ | 两边都需要 |
| applicants | ✅ JSON | ❌ | 只存MySQL |
| inventors | ✅ JSON | ❌ | 只存MySQL |
| assignees | ✅ JSON/NULL | ❌ | 可选字段 |

#### 外观专利

| 字段 | MySQL | Milvus | 说明 |
|-----|-------|--------|------|
| patent_id | ✅ 主键 | ✅ 关联键 | 两边都需要 |
| image_index | ❌ | ✅ | 标识是第几张图 |
| **image_vector** | ❌ | ✅ | 只存Milvus（DINOv2 768维） |
| loc_class | ✅ | ✅ | 两边都需要（过滤用） |
| pub_date | ✅ | ✅ | 两边都需要 |
| title | ✅ | ❌ | 只存MySQL |
| images | ✅ JSON | ❌ | 图片列表存MySQL |
| applicants | ✅ JSON | ❌ | 只存MySQL |
| expiry_date | ✅ | ❌ | 计算字段 |
